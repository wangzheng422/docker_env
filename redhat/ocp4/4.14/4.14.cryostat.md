# JVM monitoring: cryostat on openshift 4.14

We want to monitor java app, to find out misbehaving, performance issue, etc. We can use `cryostat` to do this.

In this lab, we will use a buggy java app to demonstrate how to use `cryostat` to monitor it. This buggy java app will provide a web service, during each http request, it will create 1000 new thread to call backend service, which will cause the app to hang under traffic load.

offical docs:
- https://access.redhat.com/documentation/en-us/red_hat_build_of_cryostat/2

# install cryostat

![](imgs/2024-05-06-18-46-07.png)



# deploy the buggy java app

```bash

oc create secret generic myapp-cert -n llm-demo \
  --from-file=tls.crt=/etc/crts/wzhlab.top.crt

cat << EOF > ${BASE_DIR}/data/install/cryostat-user.yaml
monitor readonly
EOF

cat << EOF > ${BASE_DIR}/data/install/cryostat-pwd.yaml
monitor redhat
EOF

oc create configmap jmx-config -n llm-demo \
    --from-file=jmxremote.access=${BASE_DIR}/data/install/cryostat-user.yaml

oc create secret generic jmx-secret -n llm-demo \
    --from-file=jmxremote.password=${BASE_DIR}/data/install/cryostat-pwd.yaml

# go back to helper
# create a dummy pod
cat << EOF > ${BASE_DIR}/data/install/demo1.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: wzh-demo-service
spec:
  ports:
    - name: service-port
      port: 80
      protocol: TCP
      targetPort: 8080
    - name: "jfr-jmx"
      port: 9091
      targetPort: 9091
    - name: "cryostat-agent"
      port: 9977
      targetPort: 9977
  selector:
    app: wzh-demo-pod

---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: wzh-demo
spec:
  to:
    kind: Service
    name: wzh-demo-service
  port:
    targetPort: service-port

apiVersion: apps/v1
kind: Deployment
metadata:
  name: wzh-demo-deployment
  labels:
    app: wzh-demo-pod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wzh-demo-pod
  template:
    metadata:
      labels:
        app: wzh-demo-pod
    spec:
      # nodeSelector:
      #   kubernetes.io/hostname: 'worker-01-demo'
      containers:
        - name: demo1
          image: quay.io/wangzheng422/qimgs:simple-java-http-server-threads-2024.05.06.v01
          env:
            - name: WZH_URL
              value: "http://172.21.6.8:13000/singbox.config.json"
            - name: JAVA_OPTS
              value: "-Dcom.sun.management.jmxremote.port=9091 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=true -Dcom.sun.management.jmxremote.registry.ssl=true -Djavax.net.ssl.keyStore=/jmx-keystore/tls.crt"
            # - name: JAVA_OPTS
            #   value: "-Dcom.sun.management.jmxremote.port=9091 -Dcom.sun.management.jmxremote.authenticate=true -Dcom.sun.management.jmxremote.password.file=/jmx-secret/jmxremote.password -Dcom.sun.management.jmxremote.access.file=/jmx-config/jmxremote.access"
            # command: [ "/bin/bash", "-c", "--" ]
            # args: [ "tail -f /dev/null" ]
            # imagePullPolicy: Always              
          volumeMounts:
            - name: jmx-config-volume
              mountPath: /jmx-config/
            - name: jmx-secret-volume
              mountPath: /jmx-secret/
            - name: keystore-volume
              mountPath: /jmx-keystore/
      volumes:
        - name: keystore-volume
          secret:
            secretName: myapp-cert
        - name: jmx-secret-volume
          secret:
            secretName: jmx-secret
        - name: jmx-config-volume
          configMap:
            name: jmx-config
EOF

oc apply -n llm-demo -f ${BASE_DIR}/data/install/demo1.yaml

# oc delete -n llm-demo -f ${BASE_DIR}/data/install/demo1.yaml

```

# open jfr 

download jre/jdk at:
- https://adoptium.net/download/

download jmc at:
- https://adoptium.net/jmc/

open jmc, and open jfr file, you can see

![](imgs/2024-05-06-19-39-41.png)

# end