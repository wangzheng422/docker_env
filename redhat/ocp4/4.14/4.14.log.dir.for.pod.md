# persistent log for pod

# using crio config

经过时间，发现crio里面，虽然有配置，说可以mount dir，但是发现挂载得只是那个目录得一个快照，容器里面往里面写得数据，不会持久化到host上面。

```bash

cat /usr/share/containers/mounts.conf
# /usr/share/rhel/secrets:/run/secrets

mkdir -p /var/wzh-local-log

chmod 755 /var/wzh-local-log

cat /usr/share/containers/mounts.conf > /etc/containers/mounts.conf

cat << EOF > /etc/containers/mounts.conf
/usr/share/rhel/secrets:/run/secrets
/var/wzh-local-log:/wzh-log
EOF


```

install cnv, and config a hostpath. We know the hostpath works for worker node, but it not work for master node.

```yaml
apiVersion: hostpathprovisioner.kubevirt.io/v1beta1
kind: HostPathProvisioner
metadata:
  name: hostpath-provisioner
spec:
  imagePullPolicy: IfNotPresent
  storagePools:
    - name: local
      path: /var/wzh-local-log
  workload:
    nodeSelector:
      kubernetes.io/os: linux

```

create a machine config, to update the crio config

```bash

export BASE_DIR=/home/dev-admin

mkdir -p ${BASE_DIR}/.local/bin

cd ${BASE_DIR}/.local/bin
wget --inet4-only -O butane-amd64 https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/butane/latest/butane-amd64

mv butane-amd64 butane
chmod +x butane


mkdir -p ${BASE_DIR}/data/install/openshift

cat << EOF > ${BASE_DIR}/data/install/98-master-crio-mount.bu
variant: openshift
version: 4.12.0
metadata:
  labels:
    machineconfiguration.openshift.io/role: master
  name: 98-master-crio-mount
storage:
  files:
    - path: /etc/containers/mounts.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          /usr/share/rhel/secrets:/run/secrets
          /var/wzh-local-log:/wzh-log
EOF

butane ${BASE_DIR}/data/install/98-master-crio-mount.bu -o ${BASE_DIR}/data/install/openshift/98-master-crio-mount.yaml

cat << EOF > ${BASE_DIR}/data/install/98-worker-crio-mount.bu
variant: openshift
version: 4.12.0
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: 98-worker-crio-mount
storage:
  files:
    - path: /etc/containers/mounts.conf
      mode: 0644
      overwrite: true
      contents:
        inline: |
          /usr/share/rhel/secrets:/run/secrets
          /var/wzh-local-log:/wzh-log
EOF

butane ${BASE_DIR}/data/install/98-worker-crio-mount.bu -o ${BASE_DIR}/data/install/openshift/98-worker-crio-mount.yaml

oc apply -f ${BASE_DIR}/data/install/openshift/

```

# using hostpath with retain policy


# end