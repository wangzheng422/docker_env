# OpenTelementry

# install and configure tempo

## create minio as S3

```bash


oc new-project observability

# on helper
S3_NAME='observability'
S3_NS='observability'
S3_IMAGE='docker.io/minio/minio:RELEASE.2021-06-17T00-10-46Z.hotfix.35a0912ff'

cat << EOF > ${BASE_DIR}/data/install/s3-codellama.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: minio-${S3_NAME}
spec:
  ports:
    - name: minio-client-port
      port: 9000
      protocol: TCP
      targetPort: 9000
  selector:
    app: minio-${S3_NAME}

# ---
# apiVersion: route.openshift.io/v1
# kind: Route
# metadata:
#   name: s3-${S3_NAME}
# spec:
#   to:
#     kind: Service
#     name: minio-${S3_NAME}
#   port:
#     targetPort: 9000

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: minio-${S3_NAME}-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: hostpath-csi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: minio-${S3_NAME}
  labels:
    app: minio-${S3_NAME}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: minio-${S3_NAME}
  template:
    metadata:
      labels:
        app: minio-${S3_NAME}
    spec:
      initContainers:
        - name: create-demo-dir
          image: docker.io/busybox
          command: ["mkdir", "-p", "/data1/demo"]
          volumeMounts:
            - name: data
              mountPath: "/data1"
      containers:
        - args:
            - server
            - /data1
          env:
            - name: MINIO_ACCESS_KEY
              value:  admin
            - name: MINIO_SECRET_KEY
              value: redhatocp
          image: ${S3_IMAGE}
          imagePullPolicy: IfNotPresent
          name: minio
          nodeSelector:
            kubernetes.io/hostname: "worker-01-demo"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
                drop:
                - ALL
            runAsNonRoot: true
            seccompProfile:
                type: RuntimeDefault
          volumeMounts:
            - mountPath: "/data1"
              name: data
      volumes:
        - name: data 
          persistentVolumeClaim:
            claimName: minio-${S3_NAME}-pvc

EOF

oc create -n observability -f ${BASE_DIR}/data/install/s3-codellama.yaml


```

## install tempo operator and configure

- https://docs.openshift.com/container-platform/4.14/observability/distr_tracing/distr_tracing_tempo/distr-tracing-tempo-installing.html

![](imgs/2024-04-12-18-00-09.png)

```bash

S3_NAME='observability'

cat << EOF > ${BASE_DIR}/data/install/tempo-codellama.yaml
---
apiVersion: v1
kind: Secret
metadata:
  name: minio-${S3_NAME}-s3
stringData:
  access_key_id: admin
  access_key_secret: redhatocp
  bucket: demo
  endpoint: http://minio-${S3_NAME}.${S3_NAME}.svc.cluster.local:9000
  # region: eu-central-1

---

apiVersion: tempo.grafana.com/v1alpha1
kind: TempoStack
metadata:
  name: simplest
spec:
  storageSize: 1Gi
  storage: 
    secret:
      name: minio-${S3_NAME}-s3
      type: s3
  resources:
    total:
      limits:
        memory: 2Gi
        cpu: 2000m
  template:
    queryFrontend:
      jaegerQuery: 
        enabled: true
        monitorTab:
          enabled: true 
          prometheusEndpoint: https://thanos-querier.openshift-monitoring.svc.cluster.local:9091 
        ingress:
          route:
            termination: edge
          type: route

EOF

oc create --save-config -n observability -f ${BASE_DIR}/data/install/tempo-codellama.yaml

# oc delete -n observability -f ${BASE_DIR}/data/install/tempo-codellama.yaml


```


# install opentelementry
select from operator hub, and install with default parameter

![](imgs/2024-04-12-16-50-37.png)

configure a collector, with configure from offical docs
- https://docs.openshift.com/container-platform/4.14/observability/otel/otel-installing.html

![](imgs/2024-04-12-16-59-13.png)

the default configue used in install doc, and with modification by author. create below in project observability

```bash

cat << EOF > ${BASE_DIR}/data/install/otel-codellama.yaml
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: otel
spec:
  mode: deployment
  observability:
    metrics:
      enableMetrics: true
  config: |
    connectors:
      spanmetrics: 
        metrics_flush_interval: 15s

    receivers:
      otlp:
        protocols:
          grpc:
          http:
      jaeger:
        protocols:
          grpc:
          thrift_binary:
          thrift_compact:
          thrift_http:
      zipkin:
    processors:
      batch:
      memory_limiter:
        check_interval: 1s
        limit_percentage: 50
        spike_limit_percentage: 30

    exporters:
      debug:

      prometheus: 
        endpoint: 0.0.0.0:8889
        add_metric_suffixes: false
        resource_to_telemetry_conversion:
          enabled: true # by default resource attributes are dropped

      otlp:
        endpoint: "tempo-simplest-distributor:4317"
        tls:
          insecure: true

    service:
      pipelines:
        traces:
          receivers: [otlp,jaeger,zipkin]
          processors: [memory_limiter,batch]
          exporters: [otlp, spanmetrics]
        metrics:
          receivers: [otlp,spanmetrics]
          processors: []
          exporters: [prometheus]

EOF

oc create --save-config -n observability -f ${BASE_DIR}/data/install/otel-codellama.yaml

# oc delete -n observability -f ${BASE_DIR}/data/install/otel-codellama.yaml

```

## try it out


```bash

cat << EOF > ${BASE_DIR}/data/install/java-instrumentation-codellama.yaml
apiVersion: opentelemetry.io/v1alpha1
kind: Instrumentation
metadata:
  name: java-instrumentation
spec:
  env:
    - name: OTEL_EXPORTER_OTLP_TIMEOUT
      value: "20"
  exporter:
    endpoint: http://otel-collector.observability.svc.cluster.local:4317
  propagators:
    - w3c
  sampler:
    type: parentbased_traceidratio
    argument: "0.25"
  java:
    env:
    - name: OTEL_JAVAAGENT_DEBUG
      value: "true"

EOF

oc create --save-config -n llm-demo -f ${BASE_DIR}/data/install/java-instrumentation-codellama.yaml

# oc delete -n llm-demo -f ${BASE_DIR}/data/install/java-instrumentation-codellama.yaml


```

# demo app

## manual inject

- https://github.com/open-telemetry/opentelemetry-java-instrumentation
- https://github.com/wangzheng422/opentelemetry-java-examples

```bash

# on vultr
# dnf install -y /usr/bin/javac

dnf install -y java-latest-openjdk-devel java-1.8.0-openjdk-devel

dnf install -y /usr/bin/podman-compose

yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

systemctl enable --now docker

mkdir -p /data
cd /data

git clone https://github.com/wangzheng422/opentelemetry-java-examples

cd /data/opentelemetry-java-examples/javaagent

git checkout wzh-2024-04-14

# ../gradlew --no-build-cache --no-configuration-cache bootJar
../gradlew bootJar

docker compose up --build

curl http://localhost:8080/ping
# pong


docker compose down

```

and you get output from docker collector

```bash

app-1        | 2024-04-14 11:55:00.849  INFO 7 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'
app-1        | 2024-04-14 11:55:00.849  INFO 7 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'
app-1        | 2024-04-14 11:55:00.852  INFO 7 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 2 ms
app-1        | 2024-04-14 11:55:00.970  INFO 7 --- [nio-8080-exec-1] i.o.example.javagent.Controller          : A sample log message!
app-1        | 2024-04-14 11:55:01.015  INFO 7 --- [nio-8080-exec-1] i.o.example.javagent.Controller          : HTTP GET response code: 200
collector-1  | 2024-04-14T11:55:01.852Z info    LogsExporter    {"kind": "exporter", "data_type": "logs", "name": "logging", "resource logs": 1, "log records": 5}
collector-1  | 2024-04-14T11:55:01.852Z info    ResourceLog #0
collector-1  | Resource SchemaURL: https://opentelemetry.io/schemas/1.23.1
collector-1  | Resource attributes:
collector-1  |      -> container.id: Str(cbb2f2612bf4baa128425aeaa6bdebfdc4cd4a7755d744fe7d55e446e351ec42)
collector-1  |      -> host.arch: Str(amd64)
collector-1  |      -> host.name: Str(cbb2f2612bf4)
collector-1  |      -> os.description: Str(Linux 5.14.0-362.24.1.el9_3.0.1.x86_64)
collector-1  |      -> os.type: Str(linux)
collector-1  |      -> process.command_args: Slice(["/opt/java/openjdk/bin/java","-jar","-javaagent:/opentelemetry-javaagent.jar","/app.jar"])
collector-1  |      -> process.executable.path: Str(/opt/java/openjdk/bin/java)
collector-1  |      -> process.pid: Int(7)
collector-1  |      -> process.runtime.description: Str(Eclipse Adoptium OpenJDK 64-Bit Server VM 11.0.22+7)
collector-1  |      -> process.runtime.name: Str(OpenJDK Runtime Environment)
collector-1  |      -> process.runtime.version: Str(11.0.22+7)
collector-1  |      -> service.name: Str(agent-example-app)
collector-1  |      -> telemetry.distro.name: Str(opentelemetry-java-instrumentation)
collector-1  |      -> telemetry.distro.version: Str(2.2.0)
collector-1  |      -> telemetry.sdk.language: Str(java)
collector-1  |      -> telemetry.sdk.name: Str(opentelemetry)
collector-1  |      -> telemetry.sdk.version: Str(1.36.0)
collector-1  | ScopeLogs #0
collector-1  | ScopeLogs SchemaURL:
collector-1  | InstrumentationScope org.apache.catalina.core.ContainerBase.[Tomcat].[localhost].[/]
collector-1  | LogRecord #0
collector-1  | ObservedTimestamp: 2024-04-14 11:55:00.849241 +0000 UTC
collector-1  | Timestamp: 2024-04-14 11:55:00.849 +0000 UTC
collector-1  | SeverityText: INFO
collector-1  | SeverityNumber: Info(9)
collector-1  | Body: Str(Initializing Spring DispatcherServlet 'dispatcherServlet')
collector-1  | Trace ID: 06398ab7d16b31a55a6c13c60ff70097
collector-1  | Span ID: 07fca14f554f38e0
collector-1  | Flags: 1
collector-1  | ScopeLogs #1
collector-1  | ScopeLogs SchemaURL:
collector-1  | InstrumentationScope io.opentelemetry.example.javagent.Controller
collector-1  | LogRecord #0
collector-1  | ObservedTimestamp: 2024-04-14 11:55:00.96997 +0000 UTC
collector-1  | Timestamp: 2024-04-14 11:55:00.969938 +0000 UTC
collector-1  | SeverityText: INFO
collector-1  | SeverityNumber: Info(9)
collector-1  | Body: Str(A sample log message!)
collector-1  | Trace ID: 06398ab7d16b31a55a6c13c60ff70097
collector-1  | Span ID: f898abd16b7838df
collector-1  | Flags: 1
collector-1  | LogRecord #1
collector-1  | ObservedTimestamp: 2024-04-14 11:55:01.015935 +0000 UTC
collector-1  | Timestamp: 2024-04-14 11:55:01.015929 +0000 UTC
collector-1  | SeverityText: INFO
collector-1  | SeverityNumber: Info(9)
collector-1  | Body: Str(HTTP GET response code: 200)
collector-1  | Trace ID: 06398ab7d16b31a55a6c13c60ff70097
collector-1  | Span ID: 40a30fac2479b7b4
collector-1  | Flags: 1
collector-1  | ScopeLogs #2
collector-1  | ScopeLogs SchemaURL:
collector-1  | InstrumentationScope org.springframework.web.servlet.DispatcherServlet
collector-1  | LogRecord #0
collector-1  | ObservedTimestamp: 2024-04-14 11:55:00.849922 +0000 UTC
collector-1  | Timestamp: 2024-04-14 11:55:00.849 +0000 UTC
collector-1  | SeverityText: INFO
collector-1  | SeverityNumber: Info(9)
collector-1  | Body: Str(Initializing Servlet 'dispatcherServlet')
collector-1  | Trace ID: 06398ab7d16b31a55a6c13c60ff70097
collector-1  | Span ID: 07fca14f554f38e0
collector-1  | Flags: 1
collector-1  | LogRecord #1
collector-1  | ObservedTimestamp: 2024-04-14 11:55:00.852566 +0000 UTC
collector-1  | Timestamp: 2024-04-14 11:55:00.852 +0000 UTC
collector-1  | SeverityText: INFO
collector-1  | SeverityNumber: Info(9)
collector-1  | Body: Str(Completed initialization in 2 ms)
collector-1  | Trace ID: 06398ab7d16b31a55a6c13c60ff70097
collector-1  | Span ID: 07fca14f554f38e0
collector-1  | Flags: 1
collector-1  |  {"kind": "exporter", "data_type": "logs", "name": "logging"}
collector-1  | 2024-04-14T11:55:03.640Z info    TracesExporter  {"kind": "exporter", "data_type": "traces", "name": "logging", "resource spans": 1, "spans": 4}
collector-1  | 2024-04-14T11:55:03.640Z info    ResourceSpans #0
collector-1  | Resource SchemaURL: https://opentelemetry.io/schemas/1.23.1
collector-1  | Resource attributes:
collector-1  |      -> container.id: Str(cbb2f2612bf4baa128425aeaa6bdebfdc4cd4a7755d744fe7d55e446e351ec42)
collector-1  |      -> host.arch: Str(amd64)
collector-1  |      -> host.name: Str(cbb2f2612bf4)
collector-1  |      -> os.description: Str(Linux 5.14.0-362.24.1.el9_3.0.1.x86_64)
collector-1  |      -> os.type: Str(linux)
collector-1  |      -> process.command_args: Slice(["/opt/java/openjdk/bin/java","-jar","-javaagent:/opentelemetry-javaagent.jar","/app.jar"])
collector-1  |      -> process.executable.path: Str(/opt/java/openjdk/bin/java)
collector-1  |      -> process.pid: Int(7)
collector-1  |      -> process.runtime.description: Str(Eclipse Adoptium OpenJDK 64-Bit Server VM 11.0.22+7)
collector-1  |      -> process.runtime.name: Str(OpenJDK Runtime Environment)
collector-1  |      -> process.runtime.version: Str(11.0.22+7)
collector-1  |      -> service.name: Str(agent-example-app)
collector-1  |      -> telemetry.distro.name: Str(opentelemetry-java-instrumentation)
collector-1  |      -> telemetry.distro.version: Str(2.2.0)
collector-1  |      -> telemetry.sdk.language: Str(java)
collector-1  |      -> telemetry.sdk.name: Str(opentelemetry)
collector-1  |      -> telemetry.sdk.version: Str(1.36.0)
collector-1  | ScopeSpans #0
collector-1  | ScopeSpans SchemaURL:
collector-1  | InstrumentationScope io.opentelemetry.tomcat-7.0 2.2.0-alpha
collector-1  | Span #0
collector-1  |     Trace ID       : 06398ab7d16b31a55a6c13c60ff70097
collector-1  |     Parent ID      :
collector-1  |     ID             : 07fca14f554f38e0
collector-1  |     Name           : GET /ping
collector-1  |     Kind           : Server
collector-1  |     Start time     : 2024-04-14 11:55:00.76785 +0000 UTC
collector-1  |     End time       : 2024-04-14 11:55:01.062865982 +0000 UTC
collector-1  |     Status code    : Unset
collector-1  |     Status message :
collector-1  | Attributes:
collector-1  |      -> http.response.status_code: Int(200)
collector-1  |      -> thread.id: Int(27)
collector-1  |      -> server.port: Int(8080)
collector-1  |      -> url.path: Str(/ping)
collector-1  |      -> network.peer.address: Str(172.19.0.1)
collector-1  |      -> server.address: Str(localhost)
collector-1  |      -> client.address: Str(172.19.0.1)
collector-1  |      -> http.route: Str(/ping)
collector-1  |      -> http.request.method: Str(GET)
collector-1  |      -> network.peer.port: Int(51172)
collector-1  |      -> url.scheme: Str(http)
collector-1  |      -> thread.name: Str(http-nio-8080-exec-1)
collector-1  |      -> user_agent.original: Str(curl/7.76.1)
collector-1  |      -> network.protocol.version: Str(1.1)
collector-1  | ScopeSpans #1
collector-1  | ScopeSpans SchemaURL:
collector-1  | InstrumentationScope io.opentelemetry.example.javagent.Application
collector-1  | Span #0
collector-1  |     Trace ID       : 06398ab7d16b31a55a6c13c60ff70097
collector-1  |     Parent ID      : f898abd16b7838df
collector-1  |     ID             : 40a30fac2479b7b4
collector-1  |     Name           : makeHttpRequest
collector-1  |     Kind           : Internal
collector-1  |     Start time     : 2024-04-14 11:55:00.971916554 +0000 UTC
collector-1  |     End time       : 2024-04-14 11:55:01.017277255 +0000 UTC
collector-1  |     Status code    : Unset
collector-1  |     Status message :
collector-1  | Attributes:
collector-1  |      -> thread.id: Int(27)
collector-1  |      -> thread.name: Str(http-nio-8080-exec-1)
collector-1  | Span #1
collector-1  |     Trace ID       : 06398ab7d16b31a55a6c13c60ff70097
collector-1  |     Parent ID      : 07fca14f554f38e0
collector-1  |     ID             : f898abd16b7838df
collector-1  |     Name           : doWork
collector-1  |     Kind           : Internal
collector-1  |     Start time     : 2024-04-14 11:55:00.907316259 +0000 UTC
collector-1  |     End time       : 2024-04-14 11:55:01.017304018 +0000 UTC
collector-1  |     Status code    : Unset
collector-1  |     Status message :
collector-1  | Attributes:
collector-1  |      -> thread.id: Int(27)
collector-1  |      -> thread.name: Str(http-nio-8080-exec-1)
collector-1  | ScopeSpans #2
collector-1  | ScopeSpans SchemaURL:
collector-1  | InstrumentationScope io.opentelemetry.http-url-connection 2.2.0-alpha
collector-1  | Span #0
collector-1  |     Trace ID       : 06398ab7d16b31a55a6c13c60ff70097
collector-1  |     Parent ID      : 40a30fac2479b7b4
collector-1  |     ID             : bec7936208de7a1b
collector-1  |     Name           : GET
collector-1  |     Kind           : Client
collector-1  |     Start time     : 2024-04-14 11:55:01.001181081 +0000 UTC
collector-1  |     End time       : 2024-04-14 11:55:01.015645718 +0000 UTC
collector-1  |     Status code    : Unset
collector-1  |     Status message :
collector-1  | Attributes:
collector-1  |      -> http.response.status_code: Int(200)
collector-1  |      -> thread.id: Int(27)
collector-1  |      -> server.port: Int(13000)
collector-1  |      -> url.full: Str(http://45.76.171.203:13000)
collector-1  |      -> thread.name: Str(http-nio-8080-exec-1)
collector-1  |      -> server.address: Str(45.76.171.203)
collector-1  |      -> network.protocol.version: Str(1.1)
collector-1  |      -> http.request.method: Str(GET)
collector-1  |  {"kind": "exporter", "data_type": "traces", "name": "logging"}


```

```bash

# save the image

docker tag javaagent-app quay.io/wangzheng422/qimgs:javaagent-app-2024.04.14

docker push quay.io/wangzheng422/qimgs:javaagent-app-2024.04.14


```

## auto inject

# end