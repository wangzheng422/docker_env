# Certification used in openshift4

```bash

oc get secret -A --field-selector type=kubernetes.io/tls -o json | jq -r '.items[] | [.metadata.namespace, .metadata.name] | join("/")'


oc get configmap -A -o json | jq -r '.items[] | select(.data["service-ca.crt"] or .data["ca-bundle.crt"]) | [.metadata.namespace, .metadata.name] | join("/")'


oc get service -A -o json | jq -r '.items[] | select(.metadata.annotations["service.beta.openshift.io/serving-cert-secret-name"]) | [.metadata.namespace, .metadata.annotations["service.beta.openshift.io/serving-cert-secret-name"]] | join("/")'


```

关于 Cert Rotation 的代码逻辑
是的，kube-apiserver-operator 的源代码中包含与证书轮换（cert rotation）相关的逻辑。OpenShift 的证书管理是其核心功能之一，kube-apiserver-operator 负责确保 kube-apiserver 的证书保持有效，包括自动轮换和更新。
以下是证书轮换逻辑可能涉及的关键部分：
证书管理的主要位置:
代码中与证书相关的逻辑通常集中在 pkg/operator/certrotationcontroller 目录下（如果目录结构未大幅调整）。这个控制器负责处理证书的生成、轮换和更新。

文件如 certrotationcontroller.go 会包含具体的实现细节。

证书轮换的实现:
OpenShift 使用 Kubernetes 的证书签名请求（CSR，Certificate Signing Request）机制来管理证书。

kube-apiserver-operator 会定期检查证书的到期时间，并在证书接近到期时（通常是有效期的 80% 或其他预定义阈值）触发轮换。

它通过与集群的证书颁发机构（CA）交互来生成新的证书，并更新 kube-apiserver 的配置以使用新证书。

关键代码文件:
pkg/operator/certrotationcontroller/certrotationcontroller.go: 这个文件通常定义了证书轮换的核心逻辑，包括检查证书有效期、生成新的 CSR 并应用新证书。

pkg/operator/configobservation/certificates/observe_certificates.go: 这个文件可能包含观察和同步证书配置的逻辑。

pkg/operator/targetconfigcontroller/targetconfigcontroller.go: 负责将证书更新应用到 kube-apiserver 的目标配置中。

自动轮换的触发:
证书轮换通常由 operator 的调谐循环（reconciliation loop）驱动。operator 会定期检查 Secret 或 ConfigMap 中存储的证书状态。

如果检测到证书即将过期，operator 会调用相关函数生成新证书并触发 kube-apiserver 的重新部署。

相关依赖:
OpenShift 的证书轮换逻辑依赖于底层的 Kubernetes 库（如 k8s.io/client-go 和 k8s.io/kubernetes）以及 OpenShift 特定的库（如 github.com/openshift/library-go）。


# end