> [WARNING] 
> Working in progress. Please check back later.
# integrate rhdh with github repo

We have a demo previous, following the doc [here](../4.15/2024.08.rhdh.book.md).

The old demo use the gitlab as source code repository, but this time we will switch to use github.

The upstream demo repository is here, it contains the newest code.
- https://github.com/redhat-gpte-devopsautomation/agnosticg.git
- https://github.com/redhat-gpe/rhdh-demo-entities.git
- https://github.com/redhat-gpe/janus-idp-gitops.git
- https://github.com/redhat-gpte-devopsautomation/backstage-workshop.git
- https://github.com/redhat-gpte-devopsautomation/software-templates.git

But We will still fork the old repo for this demo
- https://github.com/nepdemo/rhdh-book1-templates/blob/wzh-2025.05

The forked repo will focus on:
- using github repo as source code repo for new projects instead of gitlab
- trigger pipeline by monitoring github repo new commits by using cronjob instead of github webhook
- modify the pipeline to compile new image with different tag, and update the deployment with the new tag.

The overall arch for the changes:
![](./files/rhdh.github.01.drawio.png)

## prepare the github env

Following offical document
- https://docs.redhat.com/en/documentation/red_hat_developer_hub/1.5/html/authentication_in_red_hat_developer_hub/authenticating-with-github#enabling-authentication-with-github

create a personal access token in github, give it only the `read` permission, and copy the token.
- https://github.com/settings/personal-access-tokens
- `Read` access to code, commit statuses, and metadata

<img src="imgs/2025.05.rhdh.github.md/2025-05-10-23-33-07.png" heigth="600px">

create a github app
- https://github.com/settings/apps/new

## patch for demo env

create a secret under namespace `backstage`

```yaml
kind: Secret
apiVersion: v1
metadata:
  name: wzh-rhdh-credentials
data:
  GITHUB_CLIENT_SECRET: xxxxxxxxxxxxxxxxxxxx
  AUTH_GITHUB_CLIENT_ID: xxxxxxxxxxxxxxxxxxxx
  GITHUB_WEBHOOK_URL: xxxxxxxxxxxxxxxxxxxx
  GITHUB_ORGANIZATION: xxxxxxxxxxxxxxxxxxxx
  GITHUB_WEBHOOK_SECRET: xxxxxxxxxxxxxxxxxxxx
  GITHUB_PRIVATE_KEY_FILE: xxxxxxxxxxxxxxxxxxxx
  GITHUB_ORG_URL: xxxxxxxxxxxxxxxxxxxx
  AUTH_GITHUB_APP_ID: xxxxxxxxxxxxxxxxxxxx
  GITHUB_HOST_DOMAIN: xxxxxxxxxxxxxxxxxxxx
type: Opaque
```

in case of redhat demo env, patch this file:
- https://<gitlab-host>/gitops/janus-idp-gitops/-/blob/main/charts/backstage/backstage-values.yaml?ref_type=heads

```yaml
global:
  dynamic:
    plugins:
      - package: ./dynamic-plugins/dist/backstage-plugin-scaffolder-backend-module-github-dynamic
        disabled: false
upstream:
  backstage:
    # patch for secrets
    extraEnvVarsSecrets:
      - wzh-rhdh-credentials

    appConfig:
      integrations:
        github:
          - host: ${GITHUB_HOST_DOMAIN}
            apps:
              - appId: ${AUTH_GITHUB_APP_ID}
                clientId: ${AUTH_GITHUB_CLIENT_ID}
                clientSecret: ${GITHUB_CLIENT_SECRET}
                webhookUrl: ${GITHUB_WEBHOOK_URL}
                webhookSecret: ${GITHUB_WEBHOOK_SECRET}
                privateKey: |
                  ${GITHUB_PRIVATE_KEY_FILE}

      enabled:
        github: true
        githubOrg: true


```

And then update the gitops/argocd applicaion `backstage-gitops` to trigger the update.

And create some secret to the target namespace, so we can access github and image repository (like quay.io).
```bash

# oc delete project demo-play

oc new-project demo-play

oc create secret generic github-pat-secret --from-literal=pat='github_pat_xxxxxxxxxxx'

# create k8s secret from podman authfile
oc delete secret wzh-docker-authfile -n demo-play
oc create secret generic wzh-docker-authfile --from-file=config.json=podman_authfile.json -n demo-play

# https://github.com/tektoncd/catalog/tree/main/task/kaniko/0.7
```

remove all complete and error pod
```bash
oc get pods -n demo-play | grep -E 'Error|Completed' | awk '{print $1}' | xargs oc delete pod -n demo-play
```

## create the test env

import the template to rhdh
- https://github.com/nepdemo/rhdh-book1-templates/blob/wzh-2025.05/quarkus-with-angular/template.yaml

There will be an updated pipeline, it generate a new docker image with customized tag, and update the deployment with the new image.
<img src="imgs/2025.05.rhdh.github.md/2025-05-13-15-33-09.png" heigth="600px">

It also has a cronjob, which will poll the repository repeatively every 5 minutes, fetch the latest commit hash, update the state ConfigMap, and curl the event listener if a new commit is detected.
<img src="imgs/2025.05.rhdh.github.md/2025-05-13-15-34-36.png" heigth="600px">

## show me the code

The rendered project is here:
- https://github.com/nepdemo/demo-play-demo-02-gitops

There are `git-*.yaml` files under templates, which is polling script, configmap, role, and cronjobs.
- https://github.com/nepdemo/demo-play-demo-02-gitops/tree/main/helm/build/templates

There are new tekton task to generate image name, the generated image looks like `quay.io/wangzheng422/qimgs:20250513023432-3038`
- https://github.com/nepdemo/demo-play-demo-02-gitops/blob/main/helm/build/templates/prepare-image-name-task.yaml

And an updated tekton resync task to update the image in a deployment.
- https://github.com/nepdemo/demo-play-demo-02-gitops/blob/main/helm/build/templates/resynctask.yaml

The command we use to update the image is:
`oc set image deployment/$(params.COMPONENT_ID) -n $(params.NAMESPACE) quarkus-template=$(params.IMAGE)`


# end