# openshift 4.16 integration with Azure SSO

- https://cloud.redhat.com/experts/idp/entra-id-with-group-names/


- https://vmware.fqdn.nl/2023/05/10/openshift-oauth-with-azure-idp/

# azure portal setting

In your Azure portal, go to Azure Active Directory -> App registrations -> New registration

![](imgs/2024.12.azure.sso.md/2024-12-19-13-07-33.png)

As you can see, we create a `app registration` `azure-ocp-sso`. Let us find the redirect url for the openshift sso.

Get openshift sso callback host from openshift cli:

```bash
oc get route -n openshift-authentication
# NAME              HOST/PORT                                       PATH   SERVICES          PORT   TERMINATION            WILDCARD
# oauth-openshift   oauth-openshift.apps.demo-01-rhsys.wzhlab.top          oauth-openshift   6443   passthrough/Redirect   None
```

So the redirect url is `https://oauth-openshift.apps.demo-01-rhsys.wzhlab.top/oauth2callback/azure-ocp-sso` . Now we can create the `app registration` in Azure portal.

![](imgs/2024.12.azure.sso.md/2024-12-19-13-30-20.png)

After the app registration is created, we can get the `tenant id` and `client id` from the `Overview` page. Write it down for later use. 

![](imgs/2024.12.azure.sso.md/2024-12-19-13-56-45.png)

And create a `client secret` in the `Certificates & secrets` page.

![](imgs/2024.12.azure.sso.md/2024-12-19-13-57-28.png)

Write it down for later use.

![](imgs/2024.12.azure.sso.md/2024-12-19-13-58-21.png)

Now, we need go add some permissions to the app registration. Go to `API permissions` page, click `Add a permission`.

![](imgs/2024.12.azure.sso.md/2024-12-19-14-02-07.png)

Add `profile` and `email` permissions with `Delegated permissions`.

![](imgs/2024.12.azure.sso.md/2024-12-19-14-05-31.png)

For group sync, we need to add `Directory.Read.All` `GroupMember.Read.All` `User.Read.All` permission with `Application permissions`.

![](imgs/2024.12.azure.sso.md/2024-12-19-14-08-23.png)

After the permissions are added, we need to grant admin consent for the permissions.

![](imgs/2024.12.azure.sso.md/2024-12-19-14-10-16.png)

And get the endpoint of azure, write it down.

![](imgs/2024.12.azure.sso.md/2024-12-19-14-12-11.png)

We also create some groups and add some users to the groups.

- L1Support(group)
  - l1.u01(user)
  - l1.u02(user)
- L2Support(group)
  - l2.u01(user)
  - l2.u02(user)
- L3Support(group)
  - l3.u01(user)
  - l3.u02(user)

![](imgs/2024.12.azure.sso.md/2024-12-19-19-50-46.png)

![](imgs/2024.12.azure.sso.md/2024-12-19-19-51-38.png)

# openshift sso setting

Go to openshift web console, go to `Administration` -> `Cluster Settings` -> `Configuration`, search for `oauth`.

![](imgs/2024.12.azure.sso.md/2024-12-19-14-30-41.png)

In the `oauth` page, click `Add` to add a new `OpenID Connect`.

![](imgs/2024.12.azure.sso.md/2024-12-19-14-31-16.png)

Input the `name` `client id` `client secret` `endpoint`  in the openshift sso page. 

> [!NOTE]
> The `name` must be the name of the `app registration` in Azure portal.
>
> The `preferred username` must be `upn`.

- https://learn.microsoft.com/en-us/azure/openshift/configure-azure-ad-ui

![](imgs/2024.12.azure.sso.md/2024-12-19-15-37-55.png)

If you make something wrong, and want to change the config, you can edit the `oauth` object in openshift.
```bash
oc edit oauth/cluster
```

If you want to remove a user:
```bash
oc delete user <username>

oc delete identity <user-identity>
```

# openshift group sync

- https://cloud.redhat.com/experts/idp/az-ad-grp-sync/

In operator hub, search `group` and install the `Group Sync Operator`.

![](imgs/2024.12.azure.sso.md/2024-12-19-17-38-41.png)

Keep the default setting, and install.

![](imgs/2024.12.azure.sso.md/2024-12-19-17-39-49.png)

Create azure secret in openshift.

```bash
oc create secret generic azure-group-sync -n group-sync-operator \
--from-literal=AZURE_TENANT_ID=$AZURE_TENANT_ID \
--from-literal=AZURE_CLIENT_ID=$AZURE_CLIENT_ID \
--from-literal=AZURE_CLIENT_SECRET=$AZURE_CLIENT_SECRET

```

Create a `GroupSync` object in openshift, with the example config.

![](imgs/2024.12.azure.sso.md/2024-12-19-17-50-52.png)

```yaml
apiVersion: redhatcop.redhat.io/v1alpha1
kind: GroupSync
metadata:
  name: azure-groupsync
  namespace: group-sync-operator
spec:
  providers:
    - name: azure
      azure:
        credentialsSecret:
          name: azure-group-sync
          namespace: group-sync-operator
        groups:
            - L1support
            - L2support
            - L3support
        prune: false
  schedule: '* * * * *'
```

# openshift role and rolebinding

```bash


```

# end

```bash
oc get pod -n openshift-authentication

oc logs -n openshift-authentication oauth-openshift-7dcdcb7c74-fvtdr 

```

# debug