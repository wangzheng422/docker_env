# kvm compare disk and volume


```bash

dnf -y install byobu htop jq ipmitool nmstate /usr/bin/htpasswd

dnf groupinstall -y development server 'server with gui'

dnf -y install qemu-kvm libvirt libguestfs-tools virt-install virt-viewer virt-manager tigervnc-server

systemctl enable --now libvirtd


mkdir -p /data/kvm
cd /data/kvm

# create network bridge

cat << EOF >  /data/kvm/virt-net.xml
<network>
  <name>br-ocp</name>
  <forward mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
  </forward>
  <bridge name='br-ocp' stp='on' delay='0'/>
  <domain name='br-ocp'/>
  <ip address='192.168.99.1' netmask='255.255.255.0'>
  </ip>
  <ip address='192.168.77.1' netmask='255.255.255.0'>
  </ip>
  <ip address='192.168.88.1' netmask='255.255.255.0'>
  </ip>
</network>
EOF

virsh net-define --file /data/kvm/virt-net.xml
virsh net-autostart br-ocp
virsh net-start br-ocp


virsh net-list --all
#  Name      State    Autostart   Persistent
# --------------------------------------------
#  br-ocp    active   yes         yes
#  default   active   yes         yes


pvcreate -y /dev/sdb
vgcreate vgdata /dev/sdb


lvremove -f /dev/vgdata/lv01
lvremove -f /dev/vgdata/lv02
lvremove -f /dev/vgdata/lv03

# Create  50GB LV
lvcreate -L 50G -n lv01 vgdata
lvcreate -L 40G -n lv02 vgdata
lvcreate -L 30G -n lv03 vgdata

mkfs.xfs /dev/vgdata/lv03

mkdir -p /data/lv
mount /dev/vgdata/lv03 /data/lv



cd /data/kvm

wget https://mirror.web-ster.com/rocky/9/isos/x86_64/Rocky-x86_64-minimal.iso


virsh destroy demo-01
virsh undefine demo-01

SNO_MEM=16

virt-install --name=demo-01 \
--vcpus=8 \
--ram=$(($SNO_MEM*1024)) \
--cpu=host-model \
--disk path=/dev/vgdata/lv01,device=disk,bus=virtio,format=raw \
--disk path=/dev/vgdata/lv02,device=disk,bus=virtio,format=raw \
--os-variant rhel9.3 \
--network bridge=br-ocp,model=virtio \
--graphics vnc,listen=127.0.0.1,port=59005 --noautoconsole \
--boot hd,cdrom,menu=on --wait -1 \
--cdrom /data/kvm/Rocky-x86_64-minimal.iso



```

go into the vm

```bash

lsblk
# NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
# sr0          11:0    1 1024M  0 rom
# vda         252:0    0   50G  0 disk
# ├─vda1      252:1    0    1G  0 part /boot
# └─vda2      252:2    0   49G  0 part
#   └─rl-root 253:0    0   49G  0 lvm  /
# vdb         252:16   0   40G  0 disk
# vdc         252:32   0   20G  0 disk

mkfs.xfs /dev/vdb
mkfs.xfs /dev/vdc

mkdir -p /data/vdb
mkdir -p /data/vdc

mount /dev/vdb /data/vdb
mount /dev/vdc /data/vdc
```

test with fio on vdb, which is raw block disk based on lvm

```bash
fio --rw=write --ioengine=sync --fdatasync=1 --directory=/data/vdb --filename=fio.bin --size=100m --bs=8000 --name=etcd_perf --output-format=json --runtime=60 --time_based=1  | jq '.jobs[0].sync.lat_ns'

```

the output

```yaml
{
  "min": 22070,
  "max": 2389203,
  "mean": 148089.911509,
  "stddev": 75670.837530,
  "N": 176324,
  "percentile": {
    "1.000000": 113152,
    "5.000000": 118272,
    "10.000000": 120320,
    "20.000000": 122368,
    "30.000000": 123392,
    "40.000000": 124416,
    "50.000000": 124416,
    "60.000000": 125440,
    "70.000000": 127488,
    "80.000000": 134144,
    "90.000000": 199680,
    "95.000000": 284672,
    "99.000000": 528384,
    "99.500000": 593920,
    "99.900000": 700416,
    "99.950000": 733184,
    "99.990000": 839680
  }
}

```

test with fio on vdc, which is file disk based on qcow2

```bash
fio --rw=write --ioengine=sync --fdatasync=1 --directory=/data/vdc --filename=fio.bin --size=100m --bs=8000 --name=etcd_perf --output-format=json --runtime=60 --time_based=1  | jq '.jobs[0].sync.lat_ns'

```

```yaml
{
  "min": 25231,
  "max": 3918521,
  "mean": 139351.049294,
  "stddev": 60808.155382,
  "N": 361988,
  "percentile": {
    "1.000000": 115200,
    "5.000000": 119296,
    "10.000000": 122368,
    "20.000000": 124416,
    "30.000000": 125440,
    "40.000000": 126464,
    "50.000000": 127488,
    "60.000000": 128512,
    "70.000000": 129536,
    "80.000000": 132096,
    "90.000000": 140288,
    "95.000000": 160768,
    "99.000000": 419840,
    "99.500000": 497664,
    "99.900000": 544768,
    "99.950000": 774144,
    "99.990000": 1187840
  }
}
```


# end

```bash
# Remove existing partition table and create new GPT
sudo parted -s /dev/sdb mklabel gpt

# Create both partitions in one command
sudo parted -s /dev/sdb \
unit GB \
mkpart primary 0% 50 \
mkpart primary 50 100

# Verify the partitions
sudo parted -s /dev/sdb print
# Number  Start   End     Size    File system  Name     Flags
#  1      1049kB  50.0GB  50.0GB               primary
#  2      50.0GB  100GB   50.0GB               primary

lsblk
# NAME   MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
# sda      8:0    0 447.1G  0 disk
# ├─sda1   8:1    0   512M  0 part /boot/efi
# ├─sda2   8:2    0   1.9G  0 part [SWAP]
# └─sda3   8:3    0 444.7G  0 part /
# sdb      8:16   0 447.1G  0 disk
# ├─sdb1   8:17   0  46.6G  0 part
# └─sdb2   8:18   0  46.6G  0 part
```

# end